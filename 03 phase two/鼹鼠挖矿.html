<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¼¹é¼ æŒ–çŸ¿è‹±è¯­å­¦ä¹ æ¸¸æˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #8B4513 0%, #654321 50%, #2F1B14 100%);
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
        }

        .control-panel {
            width: 200px;
            background: rgba(139, 69, 19, 0.9);
            padding: 20px;
            border-right: 3px solid #654321;
        }

        .control-panel h3 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .audio-button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: 2px solid #FF8C00;
            border-radius: 8px;
            color: #8B4513;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .audio-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #8B4513 0%, #654321 50%, #2F1B14 100%);
        }

        .mole {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #8B4513;
            border-radius: 50% 50% 40% 40%;
            transition: all 0.2s;
            z-index: 10;
            border: 2px solid #654321;
        }

        .mole::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 15px;
            width: 6px;
            height: 6px;
            background: black;
            border-radius: 50%;
            box-shadow: 14px 0 black;
        }

        .mole::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            width: 10px;
            height: 3px;
            background: black;
            border-radius: 50%;
        }

        .pickaxe {
            position: absolute;
            top: -15px;
            right: -10px;
            width: 20px;
            height: 30px;
            background: linear-gradient(45deg, #CD853F 0%, #8B4513 50%, #2F4F4F 100%);
            transform: rotate(45deg);
            border-radius: 2px;
        }

        .word {
            position: absolute;
            padding: 4px 6px;
            background: none;
            border: none;
            color: black;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
            line-height: 1.2;
        }

        .word:hover {
            color: #333;
            transform: scale(1.1);
            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
        }

        .word.dug {
            opacity: 0.3;
            pointer-events: none;
        }

        .diamond {
            position: absolute;
            width: 30px;
            height: 30px;
            background: linear-gradient(45deg, #E0E0E0, #B0E0E6, #87CEEB, #4169E1);
            transform: rotate(45deg);
            border-radius: 4px;
            animation: sparkle 1s ease-in-out;
            z-index: 20;
        }

        .diamond::before,
        .diamond::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.8), transparent);
            border-radius: 4px;
        }

        .diamond::after {
            animation: shine 1s ease-in-out infinite;
        }

        @keyframes sparkle {
            0% { transform: rotate(45deg) scale(0); opacity: 0; }
            50% { transform: rotate(225deg) scale(1.2); opacity: 1; }
            100% { transform: rotate(405deg) scale(1); opacity: 1; }
        }

        @keyframes shine {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .score-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #8B4513;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #8B4513;
            text-align: center;
            z-index: 100;
            display: none;
        }

        .game-over button {
            padding: 10px 20px;
            margin: 10px;
            background: linear-gradient(45deg, #32CD32, #228B22);
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .game-over button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #8B4513;
            max-width: 300px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">æ­£åœ¨åŠ è½½æ¸¸æˆæ•°æ®...</div>
    
    <div class="game-container" id="gameContainer" style="display: none;">
        <div class="control-panel">
            <h3>ğŸµ å‘éŸ³æŒ‰é’®</h3>
            <div id="audioButtons"></div>
        </div>
        
        <div class="game-area">
            <div class="mole" id="mole">
                <div class="pickaxe"></div>
            </div>
            <div id="words"></div>
            <div id="diamonds"></div>
            
            <div class="score-panel">
                <div>ğŸ’ é’»çŸ³: <span id="score">0</span></div>
                <div>ğŸ¯ å‰©ä½™: <span id="remaining">0</span></div>
            </div>
            
            <div class="instructions">
                <h4>æ¸¸æˆè¯´æ˜:</h4>
                <p>â€¢ ç”¨æ–¹å‘é”®ç§»åŠ¨é¼¹é¼ </p>
                <p>â€¢ ç‚¹å‡»å‘éŸ³æŒ‰é’®å¬å•è¯</p>
                <p>â€¢ èµ°åˆ°å¯¹åº”å•è¯é™„è¿‘ç‚¹å‡»æŒ–æ˜</p>
                <p>â€¢ æ‰¾å¯¹äº†å°±æœ‰é’»çŸ³ï¼</p>
            </div>
        </div>
        
        <div class="game-over" id="gameOver">
            <h2>ğŸ‰ æŒ–çŸ¿å®Œæˆï¼</h2>
            <p>æ­å–œä½ æ‰¾åˆ°äº† <span id="finalScore">0</span> é¢—é’»çŸ³ï¼</p>
            <p>å‡†å¤‡å¥½è¿æ¥ä¸‹ä¸€ä¸ªæŒ‘æˆ˜äº†å—ï¼Ÿ</p>
            <button onclick="nextLevel()">ğŸ¯ ä¸‹ä¸€ä¸ªæŒ‘æˆ˜</button>
            <button onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <script>
        let gameData = {
            words: [],
            sentences: [],
            pronunciation: []
        };

        let currentLevel = 1;
        let score = 0;
        let currentWord = '';
        let molePosition = { x: 400, y: 300 };
        let wordsOnGround = [];
        let dugWords = new Set();

        // åŠ è½½æ¸¸æˆæ•°æ®
        async function loadGameData() {
            try {
                // åŠ è½½å•è¯
                const wordsResponse = await fetch('https://raw.githubusercontent.com/jamin0929/strawberry/main/03%20phase%20two/å•è¯.txt');
                const wordsText = await wordsResponse.text();
                gameData.words = wordsText.split('\n').filter(word => word.trim());

                // åŠ è½½å¥å­
                const sentencesResponse = await fetch('https://raw.githubusercontent.com/jamin0929/strawberry/main/03%20phase%20two/å¥å­.txt');
                const sentencesText = await sentencesResponse.text();
                gameData.sentences = sentencesText.split('\n').filter(sentence => sentence.trim());

                // åŠ è½½å‘éŸ³ä»£ç 
                const pronunciationResponse = await fetch('https://raw.githubusercontent.com/jamin0929/strawberry/main/03%20phase%20two/å‘éŸ³å°ä»£ç .txt');
                const pronunciationText = await pronunciationResponse.text();
                gameData.pronunciation = pronunciationText.split('\n').filter(p => p.trim());

                console.log('åŠ è½½çš„æ•°æ®:', gameData);
                
                // éšè—åŠ è½½ç•Œé¢ï¼Œæ˜¾ç¤ºæ¸¸æˆ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'flex';
                
                // åˆå§‹åŒ–æ¸¸æˆ
                initGame();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('loading').innerHTML = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            createAudioButtons();
            // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿DOMæ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                placeWordsOnGround();
                updateMolePosition();
                updateScore();
            }, 100);
        }

        // åˆ›å»ºå‘éŸ³æŒ‰é’®
        function createAudioButtons() {
            const container = document.getElementById('audioButtons');
            container.innerHTML = '';
            
            gameData.words.forEach((word, index) => {
                const button = document.createElement('button');
                button.className = 'audio-button';
                button.innerHTML = `ğŸ”Š å•è¯ ${index + 1}`;
                button.onclick = () => playWord(word, index);
                container.appendChild(button);
            });
        }

        // æ’­æ”¾å•è¯å‘éŸ³å¹¶è®¾ç½®å½“å‰å•è¯
        function playWord(word, index) {
            currentWord = word.toLowerCase().trim();
            
            // ä½¿ç”¨Web Speech APIè¿›è¡Œå‘éŸ³
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
            
            // é«˜äº®å½“å‰é€‰ä¸­çš„æŒ‰é’®
            document.querySelectorAll('.audio-button').forEach(btn => {
                btn.style.background = 'linear-gradient(45deg, #FFD700, #FFA500)';
            });
            event.target.style.background = 'linear-gradient(45deg, #FF69B4, #FF1493)';
        }

        // å°†å¥å­æ‹†åˆ†ä¸ºå•è¯ï¼Œä¿ç•™æ ‡ç‚¹
        function splitSentenceToWords(sentence) {
            // ä¿ç•™æ ‡ç‚¹ç¬¦å·ï¼ŒæŒ‰ç©ºæ ¼åˆ†å‰²
            return sentence.split(/(\s+)/).filter(part => part.trim().length > 0);
        }

        // è®¡ç®—è‡ªé€‚åº”å­—ä½“å¤§å°
        function calculateFontSize() {
            const gameArea = document.querySelector('.game-area');
            const availableWidth = gameArea.offsetWidth - 50; // ç•™å‡ºè¾¹è·
            const availableHeight = gameArea.offsetHeight - 50;
            
            // è®¡ç®—æ€»æ–‡æœ¬é•¿åº¦
            const totalText = gameData.sentences.join(' ');
            const textLength = totalText.length;
            
            // æ ¹æ®å¯ç”¨ç©ºé—´å’Œæ–‡æœ¬é‡è®¡ç®—å­—ä½“å¤§å°
            const baseSize = Math.sqrt((availableWidth * availableHeight) / textLength);
            
            // é™åˆ¶å­—ä½“å¤§å°èŒƒå›´ï¼šæœ€å°14pxï¼Œæœ€å¤§28px
            const fontSize = Math.max(14, Math.min(28, baseSize * 0.8));
            
            return Math.floor(fontSize);
        }

        // åœ¨åœ°é¢æ”¾ç½®å•è¯
        function placeWordsOnGround() {
            const wordsContainer = document.getElementById('words');
            wordsContainer.innerHTML = '';
            wordsOnGround = [];
            dugWords.clear();
            
            const gameArea = document.querySelector('.game-area');
            const containerWidth = gameArea.offsetWidth - 160; // ç•™å‡ºæ›´å¤šè¾¹è·
            const containerHeight = gameArea.offsetHeight - 160;
            const fontSize = calculateFontSize();
            
            let allParts = [];
            let sentenceStarts = [];
            
            // æ”¶é›†æ‰€æœ‰æ–‡æœ¬éƒ¨åˆ†
            gameData.sentences.forEach((sentence, sentenceIndex) => {
                sentenceStarts.push(allParts.length);
                const parts = splitSentenceToWords(sentence);
                allParts = allParts.concat(parts.map(part => ({
                    text: part,
                    sentenceIndex: sentenceIndex
                })));
            });
            
            const lineHeight = fontSize * 1.6; // å¢åŠ è¡Œé—´è·
            const wordSpacing = fontSize * 0.6; // å¢åŠ å•è¯é—´è·
            
            // å…ˆè®¡ç®—æ‰€æœ‰è¡Œçš„å†…å®¹å’Œå®½åº¦
            let lines = [];
            let currentLine = [];
            let currentLineWidth = 0;
            
            allParts.forEach((partData) => {
                const part = partData.text;
                if (part.trim() === '') return;
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                context.font = `${fontSize}px Arial`;
                const textWidth = context.measureText(part).width;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢è¡Œ
                if (currentLineWidth + textWidth + wordSpacing > containerWidth && currentLine.length > 0) {
                    lines.push({
                        parts: [...currentLine],
                        width: currentLineWidth - wordSpacing
                    });
                    currentLine = [];
                    currentLineWidth = 0;
                }
                
                currentLine.push({
                    ...partData,
                    width: textWidth
                });
                currentLineWidth += textWidth + wordSpacing;
            });
            
            // æ·»åŠ æœ€åä¸€è¡Œ
            if (currentLine.length > 0) {
                lines.push({
                    parts: [...currentLine],
                    width: currentLineWidth - wordSpacing
                });
            }
            
            // è®¡ç®—æ€»æ–‡æœ¬å—çš„é«˜åº¦
            const totalTextHeight = lines.length * lineHeight;
            
            // å±…ä¸­èµ·å§‹ä½ç½®
            const startX = (gameArea.offsetWidth - containerWidth) / 2;
            const startY = (gameArea.offsetHeight - totalTextHeight) / 2;
            
            // æ¸²æŸ“æ¯ä¸€è¡Œ
            lines.forEach((line, lineIndex) => {
                const lineY = startY + lineIndex * lineHeight;
                // å±…ä¸­æ¯ä¸€è¡Œ
                const lineStartX = startX + (containerWidth - line.width) / 2;
                
                let currentX = lineStartX;
                
                line.parts.forEach((partData) => {
                    const part = partData.text;
                    
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'word';
                    wordDiv.textContent = part;
                    wordDiv.style.fontSize = fontSize + 'px';
                    
                    // åªä¸ºçœŸæ­£çš„å•è¯è®¾ç½®ç‚¹å‡»äº‹ä»¶å’Œæ•°æ®
                    const cleanWord = part.toLowerCase().replace(/[^\w]/g, '');
                    if (cleanWord.length > 0) {
                        wordDiv.dataset.word = cleanWord;
                        wordDiv.dataset.sentence = partData.sentenceIndex;
                        wordDiv.onclick = () => digWord(wordDiv);
                        
                        wordsOnGround.push({
                            element: wordDiv,
                            word: cleanWord,
                            x: currentX,
                            y: lineY
                        });
                    } else {
                        // æ ‡ç‚¹ç¬¦å·ä¸å¯ç‚¹å‡»
                        wordDiv.style.pointerEvents = 'none';
                        wordDiv.style.opacity = '0.8';
                    }
                    
                    wordDiv.style.left = currentX + 'px';
                    wordDiv.style.top = lineY + 'px';
                    wordDiv.style.display = 'inline-block';
                    
                    wordsContainer.appendChild(wordDiv);
                    currentX += partData.width + wordSpacing;
                });
            });
        }

        // æŒ–æ˜å•è¯
        function digWord(wordElement) {
            const wordData = wordElement.dataset.word.toLowerCase().trim();
            const distance = getDistance(
                molePosition.x + 25, 
                molePosition.y + 25,
                parseInt(wordElement.style.left) + wordElement.offsetWidth/2,
                parseInt(wordElement.style.top) + wordElement.offsetHeight/2
            );
            
            // æ£€æŸ¥é¼¹é¼ æ˜¯å¦è¶³å¤Ÿæ¥è¿‘
            if (distance > 80) {
                return; // è·ç¦»å¤ªè¿œï¼Œæ— æ³•æŒ–æ˜
            }
            
            const wordKey = wordData + '_' + wordElement.style.left + '_' + wordElement.style.top;
            if (dugWords.has(wordKey)) {
                return; // å·²ç»æŒ–è¿‡äº†
            }
            
            dugWords.add(wordKey);
            wordElement.classList.add('dug');
            
            // æ£€æŸ¥æ˜¯å¦æ­£ç¡®
            if (currentWord && currentWord === wordData) {
                score++;
                createDiamond(
                    parseInt(wordElement.style.left) + wordElement.offsetWidth/2,
                    parseInt(wordElement.style.top) + wordElement.offsetHeight/2
                );
            }
            
            updateScore();
            checkGameEnd();
        }

        // åˆ›å»ºé’»çŸ³
        function createDiamond(x, y) {
            const diamond = document.createElement('div');
            diamond.className = 'diamond';
            diamond.style.left = (x - 15) + 'px';
            diamond.style.top = (y - 15) + 'px';
            
            document.getElementById('diamonds').appendChild(diamond);
            
            // 3ç§’åç§»é™¤é’»çŸ³
            setTimeout(() => {
                if (diamond.parentNode) {
                    diamond.parentNode.removeChild(diamond);
                }
            }, 3000);
        }

        // è®¡ç®—è·ç¦»
        function getDistance(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        // æ›´æ–°é¼¹é¼ ä½ç½®
        function updateMolePosition() {
            const mole = document.getElementById('mole');
            mole.style.left = molePosition.x + 'px';
            mole.style.top = molePosition.y + 'px';
        }

        // æ›´æ–°åˆ†æ•°
        function updateScore() {
            document.getElementById('score').textContent = score;
            // åªè®¡ç®—çœŸæ­£çš„å•è¯æ•°é‡ï¼ˆä¸åŒ…æ‹¬æ ‡ç‚¹ç¬¦å·ï¼‰
            const totalTargetWords = gameData.words.length;
            document.getElementById('remaining').textContent = totalTargetWords - score;
        }

        // æ£€æŸ¥æ¸¸æˆç»“æŸ
        function checkGameEnd() {
            // å½“è·å¾—çš„é’»çŸ³æ•°ç­‰äºç›®æ ‡å•è¯æ•°æ—¶æ¸¸æˆç»“æŸ
            if (score === gameData.words.length) {
                setTimeout(() => {
                    document.getElementById('finalScore').textContent = score;
                    document.getElementById('gameOver').style.display = 'block';
                }, 1000);
            }
        }

        // é”®ç›˜æ§åˆ¶ç›¸å…³å˜é‡
        let keysPressed = {};
        let moveInterval = null;
        const moveSpeed = 3; // æ¯æ¬¡ç§»åŠ¨çš„åƒç´ æ•°
        const moveDelay = 16; // ç§»åŠ¨é—´éš”(ms)ï¼Œçº¦60FPS

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            // é˜²æ­¢æŒ‰é”®é‡å¤è§¦å‘
            if (keysPressed[e.key]) return;
            
            keysPressed[e.key] = true;
            
            // å¼€å§‹ç§»åŠ¨
            if (!moveInterval && (e.key.startsWith('Arrow'))) {
                moveInterval = setInterval(moveMole, moveDelay);
            }
        });

        document.addEventListener('keyup', (e) => {
            keysPressed[e.key] = false;
            
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ–¹å‘é”®è¢«æŒ‰ä¸‹
            const hasArrowKeys = Object.keys(keysPressed).some(key => 
                key.startsWith('Arrow') && keysPressed[key]
            );
            
            // å¦‚æœæ²¡æœ‰æ–¹å‘é”®è¢«æŒ‰ä¸‹ï¼Œåœæ­¢ç§»åŠ¨
            if (!hasArrowKeys && moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
        });

        // ç§»åŠ¨é¼¹é¼ å‡½æ•°
        function moveMole() {
            const gameArea = document.querySelector('.game-area');
            if (!gameArea) return;
            
            const maxX = gameArea.offsetWidth - 50;
            const maxY = gameArea.offsetHeight - 50;
            
            let moved = false;
            
            if (keysPressed['ArrowUp']) {
                molePosition.y = Math.max(0, molePosition.y - moveSpeed);
                moved = true;
            }
            if (keysPressed['ArrowDown']) {
                molePosition.y = Math.min(maxY, molePosition.y + moveSpeed);
                moved = true;
            }
            if (keysPressed['ArrowLeft']) {
                molePosition.x = Math.max(0, molePosition.x - moveSpeed);
                moved = true;
            }
            if (keysPressed['ArrowRight']) {
                molePosition.x = Math.min(maxX, molePosition.x + moveSpeed);
                moved = true;
            }
            
            if (moved) {
                updateMolePosition();
            }
        }

        // ä¸‹ä¸€å…³
        function nextLevel() {
            currentLevel++;
            score = 0;
            currentWord = '';
            
            // æ¸…ç†ç§»åŠ¨ç›¸å…³çŠ¶æ€
            keysPressed = {};
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            
            document.getElementById('gameOver').style.display = 'none';
            initGame();
        }

        // é‡æ–°å¼€å§‹
        function restartGame() {
            currentLevel = 1;
            score = 0;
            currentWord = '';
            
            // æ¸…ç†ç§»åŠ¨ç›¸å…³çŠ¶æ€
            keysPressed = {};
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            
            document.getElementById('gameOver').style.display = 'none';
            initGame();
        }

        // å¯åŠ¨æ¸¸æˆ
        loadGameData();
    </script>
</body>
</html>